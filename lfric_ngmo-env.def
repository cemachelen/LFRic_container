Bootstrap: docker
From: ubuntu:22.04

%files
files/arch-GCC_LINUX.env /opt
files/keyword.cfg /opt
files/mosrs-cache-password /opt
files/mosrs-check /opt
files/mosrs-setup-gpg-agent /opt
files/psyclone_new.cfg /opt


%post
# Build stack


#Update and install pre-built software stack. 
apt-get -y update 
apt-get -y install ibutils iproute2 kmod 
apt-get -y install build-essential make cmake git python2 python3 python3-pip automake wget python3-pycurl subversion vim gcc gfortran  hostname nano procps psmisc rsync python3-sphinx csh bzip2 m4 zlib1g-dev subversion  libxml2-dev curl libcurl4-openssl-dev unzip emacs nano gedit time liburi-perl perl libperl-dev libdbd-mysql-perl libdatetime-perl libjson-perl libxml-simple-perl libtest-simple-perl libgl1 python3-sphinx g++ libc6-dev 


dpkg-reconfigure dash

#set locale
export LC_ALL=C

#### cd /&&tar zxvf /opt/container.tgz

BUILD_DIR=/opt/build
BASE_DIR=/container
mkdir -p $BASE_DIR
mkdir -p $BUILD_DIR

NCORES=8

FCM_VERSION=2021.05.0
CYLC_VERSION=8.3.4
ROSE_VERSION=2.1.0
PSYCLONE=3.0.0


#fcm
cd $BASE_DIR
wget https://github.com/metomi/fcm/archive/${FCM_VERSION}.tar.gz && \
            tar xfz ${FCM_VERSION}.tar.gz && \
      	    rm -f ${FCM_VERSION}.tar.gz fcm && \
      	    ln -s fcm-${FCM_VERSION} fcm
cp /opt/keyword*.cfg fcm/etc/fcm
rm -f /opt/keyword*.cfg
cp /opt/mo* fcm/bin
rm -f /opt/mo*

cp -p /usr/lib/gnupg2/gpg* /usr/libexec/

#cylc rose 

curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py
python3 -m pip install requests
rm get-pip.py
python3 -m pip install metomi-rose
python3 -m pip install cylc-flow cylc-rose
python3 -m pip install tornado
python3 -m pip install clang 
python3 -m pip install libclang 
python3 -m pip install sci-fab


export PATH=$INSTALL_DIR/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/:$INSTALL_DIR/lib:$LD_LIBRARY_PATH


#Psyclone
python3 -m pip install --no-cache-dir  --upgrade pip
#python3 -m pip install --upgrade setuptools
python3 -m pip install Jinja2
# JE - instead of using release version of PSyclone, use the latest commit to main 
# as the release versions can be out of date
#git clone --recursive https://github.com/stfc/PSyclone.git
#cd PSyclone
#pip install .[psydata]
python3 -m pip install PSyclone==$PSYCLONE
python3 -m pip install scitools-iris
python3 -m pip install geovista
python3 -m pip install esmf_regrid
python3 -m pip install ipython
ln -s /usr/bin/python3 $INSTALL_DIR/bin/python
mv /opt/psyclone_new.cfg /container/psyclone_new.cfg

%environment

export BASE_DIR=/container
export INSTALL_DIR=$BASE_DIR/usr
export CYLC_VERSION=8
export PSYCLONE_CONFIG=/container/psyclone_new.cfg


